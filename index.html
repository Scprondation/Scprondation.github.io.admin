<!DOCTYPE html>
<html>
<head>
    <title>Модератор чатов Telegram</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">  <!-- Путь к вашему CSS-файлу -->

</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="mainMenu">
            <h1>Модератор чатов Telegram</h1>
            <div class="menu">
                <button id="addBotBtn">Добавить бота</button>
                <button id="manageBtn">Управление чатами</button>
                <button id="settingsBtn">Настройки</button>
            </div>
            <div id="statusMessage" class="status"></div>
        </div>

        <!-- Меню добавления бота -->
        <div id="addBotMenu" class="hidden">
            <button class="back-btn secondary" onclick="showMainMenu()">← Назад</button>
            <h2>Добавить бота</h2>
            <div class="menu">
                <button id="addToGroupBtn">Добавить в группу</button>
                <button id="addToChannelBtn">Добавить в канал</button>
            </div>
        </div>

        <!-- Список чатов для управления -->
        <div id="manageMenu" class="hidden">
            <button class="back-btn secondary" onclick="showMainMenu()">← Назад</button>
            <h2>Ваши чаты и каналы</h2>
            <p>Выберите чат для управления:</p>
            <div id="chatList" class="chat-list">
                <!-- Список чатов будет загружен здесь -->
            </div>
        </div>

        <!-- Меню управления конкретным чатом -->
        <div id="chatManagement" class="hidden">
            <button class="back-btn secondary" onclick="showManageMenu()">← Назад</button>
            <h2 id="currentChatTitle">Управление чатом</h2>
            <div class="menu">
                <button id="editTitleBtn">Изменить название</button>
                <button id="editDescriptionBtn">Изменить описание</button>
                <button id="manageMembersBtn">Управление участниками</button>
                <button id="manageAdminsBtn">Управление администраторами</button>
                <button id="managePermissionsBtn">Настройки разрешений</button>
                <button id="manageInvitesBtn">Пригласительные ссылки</button>
            </div>
        </div>

        <!-- Форма изменения названия -->
        <div id="editTitleForm" class="hidden settings-form">
            <button class="back-btn secondary" onclick="showChatManagement()">← Назад</button>
            <h2>Изменить название</h2>
            <div class="form-group">
                <label for="newTitle">Новое название:</label>
                <input type="text" id="newTitle" placeholder="Введите новое название">
            </div>
            <button id="saveTitleBtn">Сохранить</button>
        </div>

        <!-- Форма изменения описания -->
        <div id="editDescriptionForm" class="hidden settings-form">
            <button class="back-btn secondary" onclick="showChatManagement()">← Назад</button>
            <h2>Изменить описание</h2>
            <div class="form-group">
                <label for="newDescription">Новое описание:</label>
                <textarea id="newDescription" rows="4" placeholder="Введите новое описание"></textarea>
            </div>
            <button id="saveDescriptionBtn">Сохранить</button>
        </div>

        <!-- Управление участниками -->
        <div id="manageMembersForm" class="hidden settings-form">
            <button class="back-btn secondary" onclick="showChatManagement()">← Назад</button>
            <h2>Управление участниками</h2>
            <div class="form-group">
                <label for="memberUsername">Добавить участника:</label>
                <input type="text" id="memberUsername" placeholder="@username">
                <button id="addMemberBtn" style="margin-top: 10px;">Добавить</button>
            </div>
            <div class="form-group">
                <label>Список участников:</label>
                <div id="membersList" class="chat-list">
                    <!-- Список участников будет загружен здесь -->
                </div>
            </div>
        </div>

        <!-- Управление администраторами -->
        <div id="manageAdminsForm" class="hidden settings-form">
            <button class="back-btn secondary" onclick="showChatManagement()">← Назад</button>
            <h2>Управление администраторами</h2>
            <div class="form-group">
                <label for="adminUsername">Назначить администратора:</label>
                <input type="text" id="adminUsername" placeholder="@username">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="canEditGroup"> Может изменять группу
                    </label>
                </div>
                <button id="addAdminBtn" style="margin-top: 10px;">Назначить</button>
            </div>
            <div class="form-group">
                <label>Список администраторов:</label>
                <div id="adminsList" class="chat-list">
                    <!-- Список администраторов будет загружен здесь -->
                </div>
            </div>
        </div>

        <!-- Управление разрешениями -->
        <div id="managePermissionsForm" class="hidden settings-form">
            <button class="back-btn secondary" onclick="showChatManagement()">← Назад</button>
            <h2>Настройки разрешений</h2>
            <div class="permissions-grid">
                <div class="permission-item">
                    <input type="checkbox" id="permChangeInfo" checked>
                    <label for="permChangeInfo">Изменять информацию</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="permPostMessages" checked>
                    <label for="permPostMessages">Отправлять сообщения</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="permEditMessages" checked>
                    <label for="permEditMessages">Редактировать сообщения</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="permDeleteMessages" checked>
                    <label for="permDeleteMessages">Удалять сообщения</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="permInviteUsers" checked>
                    <label for="permInviteUsers">Приглашать пользователей</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="permRestrictMembers" checked>
                    <label for="permRestrictMembers">Ограничивать участников</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="permPinMessages" checked>
                    <label for="permPinMessages">Закреплять сообщения</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="permPromoteAdmins" checked>
                    <label for="permPromoteAdmins">Назначать администраторов</label>
                </div>
            </div>
            <button id="savePermissionsBtn" style="margin-top: 20px;">Сохранить разрешения</button>
        </div>

        <!-- Управление пригласительными ссылками -->
        <div id="manageInvitesForm" class="hidden settings-form">
            <button class="back-btn secondary" onclick="showChatManagement()">← Назад</button>
            <h2>Пригласительные ссылки</h2>
            <div class="form-group">
                <label>Текущие ссылки:</label>
                <div id="invitesList" class="chat-list">
                    <!-- Список ссылок будет загружен здесь -->
                </div>
            </div>
            <div class="form-group">
                <label for="inviteExpire">Срок действия (дни):</label>
                <select id="inviteExpire">
                    <option value="1">1 день</option>
                    <option value="7">7 дней</option>
                    <option value="30" selected>30 дней</option>
                    <option value="0">Без ограничения</option>
                </select>
            </div>
            <div class="form-group">
                <label for="inviteUsage">Лимит использований:</label>
                <select id="inviteUsage">
                    <option value="1">1 использование</option>
                    <option value="5">5 использований</option>
                    <option value="10">10 использований</option>
                    <option value="0" selected>Без ограничения</option>
                </select>
            </div>
            <button id="createInviteBtn">Создать новую ссылку</button>
        </div>

        <!-- Настройки бота -->
        <div id="settingsMenu" class="hidden settings-form">
            <button class="back-btn secondary" onclick="showMainMenu()">← Назад</button>
            <h2>Настройки бота</h2>
            <div class="form-group">
                <label for="autoDeleteSpam">Автоудаление спама:</label>
                <select id="autoDeleteSpam">
                    <option value="0">Отключено</option>
                    <option value="1" selected>Включено</option>
                </select>
            </div>
            <div class="form-group">
                <label for="warnBeforeBan">Предупреждения перед баном:</label>
                <input type="number" id="warnBeforeBan" min="0" max="10" value="3">
            </div>
            <div class="form-group">
                <label for="language">Язык интерфейса:</label>
                <select id="language">
                    <option value="ru" selected>Русский</option>
                    <option value="en">English</option>
                </select>
            </div>
            <button id="saveSettingsBtn">Сохранить настройки</button>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // Инициализация приложения
        tg.expand();
        tg.enableClosingConfirmation();
        tg.MainButton.setText("Готово").hide();
        
        // Текущий выбранный чат
        let currentChat = null;
        
        // Данные приложения (в реальном приложении нужно сохранять в localStorage)
        let appData = {
            settings: {
                autoDeleteSpam: true,
                warnBeforeBan: 3,
                language: 'ru'
            },
            // Заглушка для данных чатов
            chats: [
                { 
                    id: -100123456789, 
                    title: "Моя тестовая группа", 
                    type: "group", 
                    is_admin: true,
                    description: "Тестовая группа для модерации",
                    members: [
                        { id: 123456789, username: "user1", is_admin: false },
                        { id: 987654321, username: "user2", is_admin: true }
                    ],
                    invites: [
                        { link: "https://t.me/joinchat/ABC123", expire_date: "2023-12-31", usage_limit: 10, usage_count: 3 }
                    ],
                    permissions: {
                        change_info: true,
                        post_messages: true,
                        edit_messages: true,
                        delete_messages: true,
                        invite_users: true,
                        restrict_members: true,
                        pin_messages: true,
                        promote_admins: true
                    }
                }
            ]
        };
        
        // Инициализация элементов при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Загружаем настройки
            loadSettings();
            
            // Главное меню
            document.getElementById('addBotBtn').addEventListener('click', showAddBotMenu);
            document.getElementById('manageBtn').addEventListener('click', showManageMenu);
            document.getElementById('settingsBtn').addEventListener('click', showSettingsMenu);
            
            // Меню добавления бота
            document.getElementById('addToGroupBtn').addEventListener('click', () => addBotToChat('group'));
            document.getElementById('addToChannelBtn').addEventListener('click', () => addBotToChat('channel'));
            
            // Управление чатом
            document.getElementById('editTitleBtn').addEventListener('click', showEditTitleForm);
            document.getElementById('editDescriptionBtn').addEventListener('click', showEditDescriptionForm);
            document.getElementById('manageMembersBtn').addEventListener('click', showManageMembersForm);
            document.getElementById('manageAdminsBtn').addEventListener('click', showManageAdminsForm);
            document.getElementById('managePermissionsBtn').addEventListener('click', showManagePermissionsForm);
            document.getElementById('manageInvitesBtn').addEventListener('click', showManageInvitesForm);
            
            // Формы
            document.getElementById('saveTitleBtn').addEventListener('click', saveChatTitle);
            document.getElementById('saveDescriptionBtn').addEventListener('click', saveChatDescription);
            document.getElementById('addMemberBtn').addEventListener('click', addMember);
            document.getElementById('addAdminBtn').addEventListener('click', addAdmin);
            document.getElementById('savePermissionsBtn').addEventListener('click', savePermissions);
            document.getElementById('createInviteBtn').addEventListener('click', createInvite);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // Если открыто из чата, попробуем получить информацию о чате
            if (tg.initDataUnsafe.chat) {
                currentChat = {
                    id: tg.initDataUnsafe.chat.id,
                    title: tg.initDataUnsafe.chat.title,
                    type: tg.initDataUnsafe.chat.type,
                    is_admin: true
                };
                showChatManagement();
            }
        });
        
        // Функции навигации
        function showMainMenu() {
            hideAllSections();
            document.getElementById('mainMenu').classList.remove('hidden');
        }
        
        function showAddBotMenu() {
            hideAllSections();
            document.getElementById('addBotMenu').classList.remove('hidden');
        }
        
        function showManageMenu() {
            hideAllSections();
            document.getElementById('manageMenu').classList.remove('hidden');
            loadChatList();
        }
        
        function showChatManagement() {
            hideAllSections();
            document.getElementById('chatManagement').classList.remove('hidden');
            document.getElementById('currentChatTitle').textContent = `Управление: ${currentChat.title}`;
        }
        
        function showEditTitleForm() {
            hideAllSections();
            document.getElementById('editTitleForm').classList.remove('hidden');
            document.getElementById('newTitle').value = currentChat.title;
        }
        
        function showEditDescriptionForm() {
            hideAllSections();
            document.getElementById('editDescriptionForm').classList.remove('hidden');
            document.getElementById('newDescription').value = currentChat.description || "";
        }
        
        function showManageMembersForm() {
            hideAllSections();
            document.getElementById('manageMembersForm').classList.remove('hidden');
            loadMembersList();
        }
        
        function showManageAdminsForm() {
            hideAllSections();
            document.getElementById('manageAdminsForm').classList.remove('hidden');
            loadAdminsList();
        }
        
        function showManagePermissionsForm() {
            hideAllSections();
            document.getElementById('managePermissionsForm').classList.remove('hidden');
            
            // Загружаем текущие разрешения
            const perms = currentChat.permissions || {};
            document.getElementById('permChangeInfo').checked = perms.change_info !== false;
            document.getElementById('permPostMessages').checked = perms.post_messages !== false;
            document.getElementById('permEditMessages').checked = perms.edit_messages !== false;
            document.getElementById('permDeleteMessages').checked = perms.delete_messages !== false;
            document.getElementById('permInviteUsers').checked = perms.invite_users !== false;
            document.getElementById('permRestrictMembers').checked = perms.restrict_members !== false;
            document.getElementById('permPinMessages').checked = perms.pin_messages !== false;
            document.getElementById('permPromoteAdmins').checked = perms.promote_admins !== false;
        }
        
        function showManageInvitesForm() {
            hideAllSections();
            document.getElementById('manageInvitesForm').classList.remove('hidden');
            loadInvitesList();
        }
        
        function showSettingsMenu() {
            hideAllSections();
            document.getElementById('settingsMenu').classList.remove('hidden');
            
            // Загружаем текущие настройки
            document.getElementById('autoDeleteSpam').value = appData.settings.autoDeleteSpam ? "1" : "0";
            document.getElementById('warnBeforeBan').value = appData.settings.warnBeforeBan;
            document.getElementById('language').value = appData.settings.language;
        }
        
        function hideAllSections() {
            const sections = document.querySelectorAll('.container > div');
            sections.forEach(section => {
                if (!section.classList.contains('hidden')) {
                    section.classList.add('hidden');
                }
            });
        }
        
        // Функции работы с чатами
        function addBotToChat(chatType) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.style.display = 'none';
            
            if (tg.platform !== 'unknown') {
                // В реальном приложении нужно использовать username вашего бота
                tg.openTelegramLink(`https://t.me/${tg.initDataUnsafe.user?.username || 'your_bot'}?startgroup=true`);
                
                showStatusMessage(`Бот был предложен для добавления в ${chatType === 'group' ? 'группу' : 'канал'}. Пожалуйста, завершите добавление в интерфейсе Telegram.`, 'success');
            } else {
                showStatusMessage('Это приложение должно быть открыто в Telegram для работы этой функции.', 'error');
                window.open(`https://t.me/${tg.initDataUnsafe.user?.username || 'your_bot'}?startgroup=true`, '_blank');
            }
        }
        
        function loadChatList() {
            const chatListElement = document.getElementById('chatList');
            chatListElement.innerHTML = '';
            
            appData.chats.forEach(chat => {
                if (chat.is_admin) {
                    const chatElement = document.createElement('div');
                    chatElement.className = 'chat-item';
                    chatElement.innerHTML = `
                        <div>
                            <div class="chat-title">${chat.title}</div>
                            <div class="chat-type">${chat.type === 'group' ? 'Группа' : 'Канал'}</div>
                        </div>
                    `;
                    chatElement.addEventListener('click', () => {
                        currentChat = chat;
                        showChatManagement();
                    });
                    chatListElement.appendChild(chatElement);
                }
            });
            
            if (chatListElement.children.length === 0) {
                chatListElement.innerHTML = '<p>У вас нет чатов или каналов, где вы являетесь администратором.</p>';
            }
        }
        
        function loadMembersList() {
            const membersListElement = document.getElementById('membersList');
            membersListElement.innerHTML = '';
            
            currentChat.members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'chat-item';
                memberElement.innerHTML = `
                    <div>
                        <div class="chat-title">${member.username || `ID: ${member.id}`}</div>
                        <div class="chat-type">${member.is_admin ? 'Администратор' : 'Участник'}</div>
                    </div>
                `;
                
                if (!member.is_admin) {
                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'action-buttons';
                    
                    const kickBtn = document.createElement('button');
                    kickBtn.className = 'danger';
                    kickBtn.textContent = 'Исключить';
                    kickBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        kickMember(member.id);
                    });
                    
                    const warnBtn = document.createElement('button');
                    warnBtn.className = 'secondary';
                    warnBtn.textContent = 'Предупредить';
                    warnBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        warnMember(member.id);
                    });
                    
                    actionButtons.appendChild(warnBtn);
                    actionButtons.appendChild(kickBtn);
                    memberElement.appendChild(actionButtons);
                }
                
                membersListElement.appendChild(memberElement);
            });
        }
        
        function loadAdminsList() {
            const adminsListElement = document.getElementById('adminsList');
            adminsListElement.innerHTML = '';
            
            currentChat.members
                .filter(member => member.is_admin)
                .forEach(member => {
                    const adminElement = document.createElement('div');
                    adminElement.className = 'chat-item';
                    adminElement.innerHTML = `
                        <div>
                            <div class="chat-title">${member.username || `ID: ${member.id}`}</div>
                        </div>
                    `;
                    
                    const demoteBtn = document.createElement('button');
                    demoteBtn.className = 'danger';
                    demoteBtn.textContent = 'Разжаловать';
                    demoteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        demoteAdmin(member.id);
                    });
                    
                    adminElement.appendChild(demoteBtn);
                    adminsListElement.appendChild(adminElement);
                });
        }
        
        function loadInvitesList() {
            const invitesListElement = document.getElementById('invitesList');
            invitesListElement.innerHTML = '';
            
            if (currentChat.invites && currentChat.invites.length > 0) {
                currentChat.invites.forEach(invite => {
                    const inviteElement = document.createElement('div');
                    inviteElement.className = 'chat-item';
                    
                    let usageText = '';
                    if (invite.usage_limit > 0) {
                        usageText = ` (${invite.usage_count}/${invite.usage_limit} использований)`;
                    }
                    
                    inviteElement.innerHTML = `
                        <div>
                            <div class="chat-title">${invite.link}</div>
                            <div class="chat-type">Истекает: ${invite.expire_date}${usageText}</div>
                        </div>
                    `;
                    
                    const revokeBtn = document.createElement('button');
                    revokeBtn.className = 'danger';
                    revokeBtn.textContent = 'Отозвать';
                    revokeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        revokeInvite(invite.link);
                    });
                    
                    inviteElement.appendChild(revokeBtn);
                    invitesListElement.appendChild(inviteElement);
                });
            } else {
                invitesListElement.innerHTML = '<p>Нет активных пригласительных ссылок.</p>';
            }
        }
        
        function loadSettings() {
            // В реальном приложении нужно загружать из localStorage
            const savedSettings = localStorage.getItem('moderatorSettings');
            if (savedSettings) {
                appData.settings = JSON.parse(savedSettings);
            }
        }
        
        // Функции управления чатом
        function saveChatTitle() {
            const newTitle = document.getElementById('newTitle').value.trim();
            if (!newTitle) {
                showStatusMessage('Введите новое название', 'error');
                return;
            }
            
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage(`Название чата изменено на "${newTitle}"`, 'success');
            currentChat.title = newTitle;
            setTimeout(showChatManagement, 1500);
            
            // Сохраняем изменения
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                appData.chats[chatIndex].title = newTitle;
            }
        }
        
        function saveChatDescription() {
            const newDescription = document.getElementById('newDescription').value.trim();
            
            showStatusMessage('Описание чата успешно обновлено', 'success');
            
            // Сохраняем изменения
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                appData.chats[chatIndex].description = newDescription;
            }
            
            setTimeout(showChatManagement, 1500);
        }
        
        function addMember() {
            const username = document.getElementById('memberUsername').value.trim();
            if (!username) {
                showStatusMessage('Введите username пользователя', 'error');
                return;
            }
            
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage(`Пользователь ${username} добавлен в чат`, 'success');
            
            // Добавляем в локальные данные
            const newMember = {
                id: Math.floor(Math.random() * 1000000000),
                username: username,
                is_admin: false
            };
            
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                if (!appData.chats[chatIndex].members) {
                    appData.chats[chatIndex].members = [];
                }
                appData.chats[chatIndex].members.push(newMember);
                currentChat.members = appData.chats[chatIndex].members;
            }
            
            document.getElementById('memberUsername').value = '';
            setTimeout(loadMembersList, 1500);
        }
        
        function kickMember(userId) {
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage('Пользователь исключен из чата', 'success');
            
            // Удаляем из локальных данных
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                appData.chats[chatIndex].members = appData.chats[chatIndex].members.filter(m => m.id !== userId);
                currentChat.members = appData.chats[chatIndex].members;
            }
            
            setTimeout(loadMembersList, 1500);
        }
        
        function warnMember(userId) {
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage('Пользователь получил предупреждение', 'success');
        }
        
        function addAdmin() {
            const username = document.getElementById('adminUsername').value.trim();
            if (!username) {
                showStatusMessage('Введите username пользователя', 'error');
                return;
            }
            
            const canEditGroup = document.getElementById('canEditGroup').checked;
            
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage(`Пользователь ${username} назначен администратором`, 'success');
            
            // Обновляем локальные данные
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                const memberIndex = appData.chats[chatIndex].members.findIndex(m => 
                    m.username === username || m.id === parseInt(username.replace('@', '')));
                
                if (memberIndex !== -1) {
                    appData.chats[chatIndex].members[memberIndex].is_admin = true;
                    currentChat.members = appData.chats[chatIndex].members;
                } else {
                    // Если пользователь не найден, добавляем нового
                    const newAdmin = {
                        id: Math.floor(Math.random() * 1000000000),
                        username: username,
                        is_admin: true
                    };
                    appData.chats[chatIndex].members.push(newAdmin);
                    currentChat.members = appData.chats[chatIndex].members;
                }
            }
            
            document.getElementById('adminUsername').value = '';
            setTimeout(loadAdminsList, 1500);
        }
        
        function demoteAdmin(userId) {
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage('Администратор разжалован', 'success');
            
            // Обновляем локальные данные
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                const memberIndex = appData.chats[chatIndex].members.findIndex(m => m.id === userId);
                if (memberIndex !== -1) {
                    appData.chats[chatIndex].members[memberIndex].is_admin = false;
                    currentChat.members = appData.chats[chatIndex].members;
                }
            }
            
            setTimeout(loadAdminsList, 1500);
        }
        
        function savePermissions() {
            const permissions = {
                change_info: document.getElementById('permChangeInfo').checked,
                post_messages: document.getElementById('permPostMessages').checked,
                edit_messages: document.getElementById('permEditMessages').checked,
                delete_messages: document.getElementById('permDeleteMessages').checked,
                invite_users: document.getElementById('permInviteUsers').checked,
                restrict_members: document.getElementById('permRestrictMembers').checked,
                pin_messages: document.getElementById('permPinMessages').checked,
                promote_admins: document.getElementById('permPromoteAdmins').checked
            };
            
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage('Разрешения успешно обновлены', 'success');
            
            // Сохраняем изменения
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                appData.chats[chatIndex].permissions = permissions;
                currentChat.permissions = permissions;
            }
            
            setTimeout(showChatManagement, 1500);
        }
        
        function createInvite() {
            const expireDays = parseInt(document.getElementById('inviteExpire').value);
            const usageLimit = parseInt(document.getElementById('inviteUsage').value);
            
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            const newInvite = {
                link: `https://t.me/joinchat/${Math.random().toString(36).substring(2, 10)}`,
                expire_date: expireDays > 0 ? 
                    new Date(Date.now() + expireDays * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : 
                    "Никогда",
                usage_limit: usageLimit,
                usage_count: 0
            };
            
            showStatusMessage('Новая пригласительная ссылка создана', 'success');
            
            // Добавляем в локальные данные
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                if (!appData.chats[chatIndex].invites) {
                    appData.chats[chatIndex].invites = [];
                }
                appData.chats[chatIndex].invites.push(newInvite);
                currentChat.invites = appData.chats[chatIndex].invites;
            }
            
            setTimeout(loadInvitesList, 1500);
        }
        
        function revokeInvite(link) {
            // В реальном приложении нужно отправить запрос через Telegram WebApp API
            showStatusMessage('Пригласительная ссылка отозвана', 'success');
            
            // Удаляем из локальных данных
            const chatIndex = appData.chats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                appData.chats[chatIndex].invites = appData.chats[chatIndex].invites.filter(i => i.link !== link);
                currentChat.invites = appData.chats[chatIndex].invites;
            }
            
            setTimeout(loadInvitesList, 1500);
        }
        
        function saveSettings() {
            const newSettings = {
                autoDeleteSpam: document.getElementById('autoDeleteSpam').value === "1",
                warnBeforeBan: parseInt(document.getElementById('warnBeforeBan').value),
                language: document.getElementById('language').value
            };
            
            appData.settings = newSettings;
            localStorage.setItem('moderatorSettings', JSON.stringify(newSettings));
            
            showStatusMessage('Настройки сохранены', 'success');
            setTimeout(showMainMenu, 1500);
        }
        
        // Вспомогательные функции
        function showStatusMessage(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            
            // Автоматически скрываем сообщение через 5 секунд
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        // Обработка данных из Telegram
        if (tg.initData) {
            // Можно использовать данные инициализации для авторизации
            console.log('Init data:', tg.initData);
            console.log('User:', tg.initDataUnsafe.user);
            console.log('Chat:', tg.initDataUnsafe.chat);
        }
        
        // Обработчик закрытия приложения
        tg.onEvent('viewportChanged', () => {
            tg.expand();
        });
    </script>
</body>
</html>
